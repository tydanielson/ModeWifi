# Security Documentation

## ‚ö†Ô∏è CRITICAL - This is a Personal Project

**This AWS infrastructure is configured for YOUR ACCOUNT ONLY.**

## Current Security Measures

### 1. Certificate-Based Authentication
- **Each device requires unique X.509 certificates** generated by YOUR AWS account
- Certificates are cryptographically signed by AWS IoT
- Cannot be forged or reused across accounts
- **Result**: Only devices with your certificates can connect

### 2. Restrictive IAM Policy
The IoT policy restricts devices to:
- **Connect**: Only as client ID matching thing name (`storyteller-van-01`)
- **Publish**: Only to topics under `van/storyteller-van-01/*`
- **Subscribe**: Only to `van/storyteller-van-01/commands`
- **Result**: Even with valid certs, devices can ONLY access their own topics

### 3. Account Isolation
- All resources are deployed in YOUR AWS account (237998932607)
- AWS accounts are completely isolated from each other
- IoT endpoint is account-specific: `<random>.iot.us-east-1.amazonaws.com`
- **Result**: Other AWS accounts cannot access your IoT endpoint

### 4. Gitignored Sensitive Files
The following are NEVER committed:
```
terraform.tfvars      # Your AWS profile and configuration
certificates/         # Private keys and device certificates
*.pem, *.key, *.crt  # Certificate files
*.tfstate            # Terraform state (contains resource IDs)
.terraform/          # Terraform cache
```

## What Others CAN'T Do (Even with the Code)

‚ùå **Cannot connect to your IoT endpoint** - They don't have your certificates
‚ùå **Cannot generate certificates** - Requires AWS credentials for YOUR account
‚ùå **Cannot access your data** - DynamoDB is in your account
‚ùå **Cannot deploy to your account** - Requires your AWS credentials
‚ùå **Cannot see your endpoint URL** - Only visible after YOUR terraform deploy

## What Others CAN Do (This is OK)

‚úÖ **Copy the Terraform code** - GPL v3 allows this
‚úÖ **Deploy to THEIR OWN AWS account** - Creates separate, isolated infrastructure
‚úÖ **Generate THEIR OWN certificates** - Only work with their account
‚úÖ **Build the ESP32 code** - But must use their own certificates/endpoint

## Additional Security Recommendations

### For Maximum Security

1. **Enable AWS CloudTrail**
   - Logs all API calls to your account
   - Detect unauthorized access attempts
   - Cost: Free tier covers most usage

2. **Set up AWS Budgets**
   - Alert if spending exceeds expected ($0.10/month)
   - Detect if someone compromises your account
   - Cost: Free (2 budgets included)

3. **Enable MFA on AWS Account**
   - Protect your AWS SSO/root account
   - Prevents credential theft

4. **Rotate Certificates Annually**
   - ESP32 certificates should be rotated
   - Use AWS IoT certificate rotation

5. **Monitor IoT Metrics**
   - Set up CloudWatch alarms for:
     - Unusual number of connections
     - Failed authentication attempts
     - Message rate spikes

### Certificate Security

**CRITICAL**: The ESP32 code will contain:
- Device certificate (public) - OK to have
- Private key (secret) - **NEVER share this**

If someone gets your **private key**, they could:
- Connect to your IoT endpoint as your device
- Publish fake telemetry
- Subscribe to commands

**Mitigation**:
- Store private key in ESP32 flash memory only
- Never print private key in serial output
- Never commit to git
- If compromised: revoke certificate in AWS console

## Threat Model

### Low Risk
- ‚úÖ Someone clones your GitHub repo
- ‚úÖ Someone reads your Terraform code
- ‚úÖ Someone deploys to their own AWS account

### Medium Risk
- ‚ö†Ô∏è Someone gains physical access to your ESP32
  - Can extract private key from flash memory
  - **Mitigation**: Enable ESP32 flash encryption (future)

### High Risk
- üî¥ Someone compromises your AWS credentials
  - Can access all resources in your account
  - **Mitigation**: Use MFA, monitor CloudTrail

- üî¥ Private key is leaked (committed to git, printed in logs)
  - Can impersonate your device
  - **Mitigation**: Revoke certificate immediately in AWS IoT console

## For Public GitHub Repository

Since your repo is public (GPL v3), the code is visible to everyone. This is SAFE because:

1. **No credentials in code** - All secrets in gitignored files
2. **Certificate-based auth** - Others can't generate your certificates
3. **Account isolation** - Others deploy to their own AWS accounts
4. **Infrastructure as code** - Easy to audit what gets deployed

## Emergency Response

**If you suspect compromise:**

1. **Revoke device certificates immediately**
   ```bash
   aws iot update-certificate --certificate-id <ID> --new-status REVOKED --profile default
   ```

2. **Check CloudTrail logs**
   ```bash
   aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=Connect --profile default
   ```

3. **Review IoT metrics** in CloudWatch console

4. **Rotate all certificates** and redeploy to ESP32

## Questions?

- **Q**: Can others use my IoT endpoint URL?
  - **A**: No, they need your device certificates (which they don't have)

- **Q**: Should I keep my repo private?
  - **A**: Not necessary. The code has no secrets. GPL v3 encourages sharing.

- **Q**: What if I accidentally commit certificates?
  - **A**: Revoke them immediately in AWS console, generate new ones, never force-push (history stays)

- **Q**: Can I share my ESP32 with others?
  - **A**: Only if you trust them. The device has your private key stored on it.

## Compliance

- **GPL v3**: Requires sharing source code (no security issue)
- **AWS IoT**: Meets AWS security best practices
- **MQTT TLS**: All data encrypted in transit
- **At Rest**: DynamoDB encrypts data automatically
